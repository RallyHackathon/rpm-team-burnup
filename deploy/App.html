<!DOCTYPE html>
<html>
<head>
    <title>rpm_iteration_team_flow</title>

    <script type="text/javascript" src="/apps/2.0rc1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                (function(){Ext.define("CustomApp.RpmTree",{init:function(){function drawTree(roots){App.down("#rpmTreeContainer").add({xtype:"treepanel",store:Ext.create("Ext.data.TreeStore",{root:{expanded:!0,children:roots}}),id:"rpmTree",rootVisible:!1,margin:"-1 0 0 0",border:0,listeners:{beforeitemexpand:function(node){node.hasChildNodes()===!1&&Ext.create("Rally.data.WsapiDataStore",{autoLoad:!0,model:"PortfolioItem/"+(1===node.get("depth")?"Rollup":"Feature"),filters:[{property:"Parent.ObjectID",value:node.raw.id}],fetch:["Children","LeafStoryCount","Name","ObjectID"],listeners:{load:function(store,records){var children=[];Ext.Array.each(records,function(record){children.push({name:record.raw.Name,text:'<span class="leafStoryCount">'+record.raw.LeafStoryCount+'</span> - <span class="nodeTitle">'+record.raw.Name+"</span>",id:record.raw.ObjectID,leaf:void 0==record.raw.Children||0==record.raw.Children.Count})}),Ext.Array.each(children.sort(function(a,b){return a.name>b.name?1:a.name<b.name?-1:0}),function(n){node.appendChild(n)})}}})},selectionchange:function(model,selected,eOpts){App.update(selected[0])}}})}Ext.create("Rally.data.WsapiDataStore",{autoLoad:!0,model:"PortfolioItem/Initiative",fetch:["Children","LeafStoryCount","Name","ObjectID"],listeners:{load:function(store,data){if(0==data.length)return App.removeAll(),Ext.getBody().unmask(),Ext.Msg.alert("Error",'<div class="error">This app must be ran within a context which features Initiative Portfolio Items.<br />Please change your project scope and try again.</div>'),void 0;var roots=[];Ext.Array.each(data,function(i){roots.push({name:i.raw.Name,text:'<span class="leafStoryCount">'+i.raw.LeafStoryCount+'</span> - <span class="nodeTitle">'+i.raw.Name+"</span>",id:i.raw.ObjectID,leaf:void 0==i.raw.Children||0==i.raw.Children.Count})}),roots.sort(function(a,b){return a.name>b.name?1:a.name<b.name?-1:0}),drawTree(roots)}}})}})})();
                Ext.define("CustomApp.DataAggregator",{requires:["Deft.Deferred"],config:{selection:null,results:[],teams:[]},constructor:function(config){this.loadPromise=Ext.create("Deft.Deferred"),Ext.apply(this,config)},load:function(){var me=this;return this.dates=this.aggregateDates(),_.each(this.dates,function(date){me.loadDate(date)}),this.loadPromise.promise},loadDate:function(date){Ext.create("Rally.data.lookback.SnapshotStore",{fetch:["PlanEstimate","Project","ScheduleState","Iteration"],hydrate:["ScheduleState"],filters:[{property:"__At",value:date},{property:"_TypeHierarchy",value:"HierarchicalRequirement"},{property:"_ItemHierarchy",operator:"in",value:this.selection.data.id},{property:"Iteration",operator:"!=",value:null},{property:"Children",value:null},{property:"PlanEstimate",operator:">",value:0},{property:"Project",operator:"in",value:App.visibleProjects}]}).load({scope:this,callback:function(records,operation,success){this.results.push({date:date,records:_.filter(records,function(record){return-1!==_.indexOf(App.validIterations,record.get("Iteration"))})}),this.results.length===this.dates.length&&(this.aggregateResults(),this.loadPromise.resolve())}})},aggregateDates:function(){for(var startDate=Rally.util.DateTime.fromIsoString(App.down("#iterationPicker").getRecord().get("StartDate")),endDate=Ext.Date.add(Rally.util.DateTime.fromIsoString(App.down("#iterationPicker").getRecord().get("EndDate")),Ext.Date.DAY,3),thisDay=startDate,dates=[];endDate>=thisDay;)dates.push(Rally.util.DateTime.toIsoString(thisDay)),thisDay=Ext.Date.add(thisDay,Ext.Date.DAY,1);return dates},aggregateResults:function(){var me=this;_.each(this.results,function(dateRecord){dateRecord.teams={},dateRecord.TotalPlanEstimate=0,_.each(dateRecord.records,function(record){void 0===dateRecord.teams[record.get("Project")]&&(dateRecord.teams[record.get("Project")]={"Initial Version":0,Defined:0,"In-Progress":0,Completed:0,Accepted:0}),dateRecord.teams[record.get("Project")][record.get("ScheduleState")]+=record.get("PlanEstimate"),dateRecord.TotalPlanEstimate+=record.get("PlanEstimate"),me.teams.push(record.get("Project"))})})}});
                Ext.define("CustomApp.AreaChart",{config:{data:void 0,teams:void 0,teamMap:{}},constructor:function(config){Ext.apply(this,config)},display:function(){if(0===this.teams.length)return App.down("#viewport").removeAll(),Ext.Msg.alert("Error","No accepted work has been found using the selected criteria."),void 0;var filter=[];_.each(_.unique(this.teams),function(teamId){filter.push({property:"ObjectID",value:teamId})}),Ext.create("Rally.data.WsapiDataStore",{model:"Project",fetch:["Name","ObjectID"],filters:Rally.data.QueryFilter.or(filter)}).load({scope:this,callback:function(records,operation,success){var me=this;_.each(records,function(record){me.teamMap[record.get("ObjectID")]=record.get("Name")}),me.data.sort(function(a,b){return a.date>b.date?1:a.date<b.date?-1:0}),_.each(me.data,function(dateRecord){dateRecord.date=Ext.Date.format(Rally.util.DateTime.fromIsoString(dateRecord.date),"M d, Y")});var series=[{name:"TotalPlanEstimate",type:"line",data:_.pluck(me.data,"TotalPlanEstimate")}];_.each(_.keys(me.teamMap),function(teamOID){var data=[];_.each(me.data,function(dateRecord){var teamEntry=dateRecord.teams[teamOID];void 0!==teamEntry?data.push(teamEntry.Accepted):data.push(0)}),series.push({name:me.teamMap[teamOID],type:"area",data:data})}),Ext.Array.each(series,function(entry){shouldRemove=_.all(entry.data,function(dataPoint){return 0===dataPoint}),shouldRemove&&Ext.Array.remove(series,entry)},this,!0),App.down("#viewport").removeAll(),App.down("#viewport").add({xtype:"rallychart",id:"chart",chartData:{series:series,categories:_.pluck(me.data,"date")},chartConfig:{xAxis:{plotLines:[{color:"#FF0000",width:3,dashStyle:"LongDash",value:series[0].data.length-4}],labels:{rotation:-45,align:"right",style:{fontSize:"13px",fontFamily:"Verdana, sans-serif"}}},yAxis:{title:{text:"Accepted Plan Estimate"}},chart:{width:Ext.get("viewport").getWidth()-30,height:Ext.getBody().getHeight()-30},title:{text:'"'+App.down("#rpmTree").getSelectionModel().getSelection()[0].raw.name+'" - '+App.down("#iterationPicker").getRawValue()+" - Team Acceptance Trend"},tooltip:{shared:!0,valueSuffix:" Points",headerFormat:'<span style="font-size:16px;font-weight:bold;">{point.key}</span><br/>'},plotOptions:{area:{trackByArea:!0,stacking:"normal",lineColor:"#666666",lineWidth:1,marker:{lineWidth:1,lineColor:"#666666"},cursor:"pointer",events:{click:function(){me.showTeamTrend(this.name)}}}}},listeners:{afterrender:function(){this.unmask()}}})}})},showTeamTrend:function(teamName){var series=[{name:"Initial Version",data:[]},{name:"Defined",data:[]},{name:"In-Progress",data:[]},{name:"Completed",data:[]},{name:"Accepted",data:[]}],teamOID=_.keys(this.teamMap)[_.indexOf(_.values(this.teamMap),teamName)];_.each(this.data,function(dateRecord){_.each(_.keys(dateRecord.teams[teamOID]),function(scheduleState){seriesEntry=_.find(series,function(seriesObj){return seriesObj.name===scheduleState}),seriesEntry.data.push(dateRecord.teams[teamOID][scheduleState])})}),App.popup=Ext.create("Rally.ui.dialog.Dialog",{autoShow:!0,width:Ext.getBody().getWidth()-50,height:Ext.getBody().getHeight()-50,autoScroll:!0,closable:!0,draggable:!0,resizable:!0,title:"",items:[{xtype:"rallychart",id:"popupChart",chartData:{series:series,categories:_.pluck(this.data,"date")},chartConfig:{xAxis:{plotLines:[{color:"#FF0000",width:3,dashStyle:"LongDash",value:series[0].data.length-4}]},yAxis:{title:{text:"Plan Estimate"}},chart:{type:"area",width:Ext.getBody().getWidth()-100,height:Ext.getBody().getHeight()-100},title:{text:'"'+App.down("#rpmTree").getSelectionModel().getSelection()[0].raw.name+'" - "'+teamName+'" - '+App.down("#iterationPicker").getRawValue()+" - Schedule State Trend"},tooltip:{shared:!0,valueSuffix:" Points"},plotOptions:{area:{stacking:"normal",lineColor:"#666666",lineWidth:1,marker:{lineWidth:1,lineColor:"#666666"}}}},listeners:{afterrender:function(){this.unmask()}}}],listeners:{afterrender:function(){this.toFront(),this.focus()}}})}});
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",requires:["Deft.Deferred"],layout:"border",defaults:{collapsible:!0,collapsed:!1,autoScroll:!0,split:!0},items:[{title:"Settings",id:"popout",region:"west",margins:"5 0 0 0",width:270,layout:{type:"vbox",align:"stretch"},items:[{id:"settingsPanel",layout:"vbox",height:38,border:0,padding:5,style:{borderBottom:"1px solid #99BCE8"},defaults:{width:270,margins:"3 0 0 0"},items:[{xtype:"rallyiterationcombobox",id:"iterationPicker",listeners:{ready:function(){App.updateValidIterations()},change:function(){var selection=App.down("#rpmTree").getSelectionModel().getSelection();App.updateValidIterations(),selection.length>0&&App.update(selection[0])}}}]},{id:"rpmTreeContainer",layout:"fit",border:0,flex:1}]},{id:"viewport",collapsible:!1,region:"center",margins:"5 0 0 0"}],launch:function(){App=this,App.initializeRpmTree(),App.initializeVisibleProjects()},initializeRpmTree:function(){App.tree=Ext.create("CustomApp.RpmTree"),App.tree.init()},initializeVisibleProjects:function(){Ext.create("Rally.data.WsapiDataStore",{model:"Project",fetch:["ObjectID"],limit:1/0,autoLoad:!0,listeners:{load:function(store,records){App.visibleProjects=_.map(records,function(record){return record.get("ObjectID")})}}})},update:function(selection){Ext.getBody().mask("Loading"),App.deferred.then({success:function(){App.dataAggregator=Ext.create("CustomApp.DataAggregator",{selection:selection,results:[],teams:[]}),App.dataAggregator.load().then({success:function(){Ext.getBody().unmask(),App.createAndDisplayChart()}})}})},createAndDisplayChart:function(){App.chart=Ext.create("CustomApp.AreaChart",{data:App.dataAggregator.getResults(),teams:App.dataAggregator.getTeams()}),App.chart.display()},updateValidIterations:function(){App.deferred=Ext.create("Deft.Deferred"),Ext.create("Rally.data.WsapiDataStore",{autoLoad:!0,limit:1/0,model:"Iteration",fetch:["Name","ObjectID"],filters:[{property:"Name",value:App.down("#iterationPicker").getRawValue()}],listeners:{load:function(store,records){App.validIterations=_.map(records,function(record){return record.get("ObjectID")}),App.deferred.resolve()}}})}});

            Rally.launchApp('CustomApp', {
                name:"rpm_iteration_team_flow",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        #iterationPicker-inputEl.x-form-field {
	width: 205px !important;
}

.x-tree-icon { display : none !important; }

#rpmTree .x-grid-cell-inner .leafStoryCount {
	width         : 25px;
	border        : 1px solid #B7841F;
	display       : inline-block;
	text-align    : center;
	font-size     : 9px;
	height        : 13px;
	line-height   : 12px;
	border-radius : 3px;
	background    : #ffff99;
	background    : -moz-linear-gradient(top,  #ffff99 0%, #ffd46f 100%);
	background    : -webkit-gradient(linear, left top, left bottom, color-stop(0%,#ffff99), color-stop(100%,#ffd46f));
	background    : -webkit-linear-gradient(top,  #ffff99 0%,#ffd46f 100%);
	background    : -o-linear-gradient(top,  #ffff99 0%,#ffd46f 100%);
	background    : -ms-linear-gradient(top,  #ffff99 0%,#ffd46f 100%);
	background    : linear-gradient(to bottom,  #ffff99 0%,#ffd46f 100%);
	filter        : progid:DXImageTransform.Microsoft.gradient( startColorstr='#ffff99', endColorstr='#ffd46f',GradientType=0 );
}
    </style>
</head>
<body></body>
</html>
